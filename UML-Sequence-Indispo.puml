@startuml Sequence Indispo
skinparam titleBorderRoundCorner 15
skinparam titleBorderThickness 2
skinparam titleBorderColor black

title Unavailability Drivers and Vehicles

actor TourManager

participant "TourController" as Controller
participant "UnavailabilityService" as UnavailabilityService
participant "DriverRepository" as DriverRepo
participant "VehicleRepository" as VehicleRepo
participant "EntityManager" as EM
database "Database" as DB

TourManager -> Controller : RequestAvailability(startDate, endDate)
Controller -> UnavailabilityService : getAvailableResources(startDate, endDate)
UnavailabilityService -> DriverRepo : findAvailableDrivers(startDate, endDate)
DriverRepo -> DB : Query available drivers
DB --> DriverRepo : List of available drivers
DriverRepo --> UnavailabilityService : List of available drivers

UnavailabilityService -> VehicleRepo : findAvailableVehicles(startDate, endDate)
VehicleRepo -> DB : Query available vehicles
DB --> VehicleRepo : List of available vehicles
VehicleRepo --> UnavailabilityService : List of available vehicles

UnavailabilityService --> Controller : available drivers and vehicles
Controller --> TourManager : Propose available drivers and vehicles

TourManager -> Controller : SelectDriverAndVehicle(driverId, vehicleId)
Controller -> UnavailabilityService : validateAvailability(driverId, vehicleId, startDate, endDate)
UnavailabilityService -> DriverRepo : isDriverAvailable(driverId, startDate, endDate)
DriverRepo -> DB : Check driver availability
DB --> DriverRepo : Availability confirmed (true/false)
DriverRepo --> UnavailabilityService : true/false

alt Driver Available
    UnavailabilityService -> VehicleRepo : isVehicleAvailable(vehicleId, startDate, endDate)
    VehicleRepo -> DB : Check vehicle availability
    DB --> VehicleRepo : Availability confirmed (true/false)
    VehicleRepo --> UnavailabilityService : true/false

    alt Vehicle Available
        UnavailabilityService -> EM : persist(Tour)
        EM -> DB : Insert Tour record
        DB --> EM : Insert confirmation
        EM --> UnavailabilityService : Tour persisted
        UnavailabilityService --> Controller : Tour assignment successful
    else Vehicle Unavailable
        UnavailabilityService --> Controller : Error - Vehicle unavailable
    end
else Driver Unavailable
    UnavailabilityService --> Controller : Error - Driver unavailable
end

Controller --> TourManager : Confirmation assignation reussie / Error message
destroy TourManager

@enduml
